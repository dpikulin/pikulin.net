<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pikulin Weather Station</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f0f4f8; }
    nav { display: flex; justify-content: center; background: #004d80; padding: 1rem; }
    nav button { background: #fff; border: none; padding: 0.5rem 1rem; margin: 0 0.5rem; cursor: pointer; font-weight: bold; border-radius: 5px; }
    nav button.active { background: #ffd700; }
    section { display: none; padding: 2rem; }
    section.active { display: block; }
    #live-icon { font-size: 4rem; margin: 1rem 0; }
    .error { color: red; }
    canvas { max-width: 800px; margin: 2rem auto; display: block; background: white; padding: 1rem; border-radius: 8px; }
    .csv-buttons, .range-buttons { text-align: center; margin-top: 1rem; }
    .csv-buttons button, .range-buttons button { margin: 0.3rem; padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; background: #004d80; color: #fff; }
  </style>
</head>
<body>
  <nav>
    <button onclick="showTab('live')" class="active">Live</button>
    <button onclick="showTab('trends')">Trends</button>
    <button onclick="showTab('forecast')">Forecast</button>
    <button onclick="showTab('archive')">Historical Archive</button>
    <button onclick="showTab('webcam')">Webcam</button>
  </nav>

  <section id="live" class="active">
    <h2>Live Weather</h2>
    <div id="live-icon">‚õÖ</div>
    <div id="live-weather">Loading...</div>
  </section>

  <section id="trends">
    <h2>Weather Trends</h2>
    <canvas id="trendChart"></canvas>
    <div class="csv-buttons">
      <p>Download Data as CSV:</p>
      <button onclick="downloadCSV(1)">24 Hours</button>
      <button onclick="downloadCSV(7)">7 Days</button>
      <button onclick="downloadCSV(30)">30 Days</button>
      <button onclick="downloadCSV(365)">1 Year</button>
    </div>
  </section>

  <section id="forecast">
    <h2>Forecast</h2>
    <p>Coming soon!</p>
  </section>

  <section id="archive">
    <h2>Historical Archive</h2>
    <div class="range-buttons">
      <p>Choose Range:</p>
      <button onclick="loadArchive(1)">24 Hours</button>
      <button onclick="loadArchive(7)">7 Days</button>
      <button onclick="loadArchive(30)">30 Days</button>
      <button onclick="loadArchive(365)">1 Year</button>
    </div>
    <canvas id="tempChart"></canvas>
    <canvas id="humidityChart"></canvas>
    <canvas id="pressureChart"></canvas>
    <canvas id="windChart"></canvas>
    <canvas id="precipChart"></canvas>
    <canvas id="lightningChart"></canvas>
  </section>

  <section id="webcam">
    <h2>Webcam</h2>
    <p>Webcam page coming soon!</p>
  </section>

  <script>
    const token = 'a3808762-f028-4161-bf9d-085ed84725b8';
    const stationId = 148425;
    let trendChartInstance = null;
    let archiveCharts = {};

    function showTab(tabId) {
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
      if (tabId === 'archive') loadArchive(7);
    }

    function getIconFromConditions(obs) {
      if (!obs) return '‚ùì';
      if (obs.lightning_strike_count_last_3hr > 0) return 'üå©Ô∏è';
      if (obs.precip > 0) return 'üåßÔ∏è';
      if (obs.wind_avg > 6) return 'üå¨Ô∏è';
      if (obs.air_temperature < 0) return '‚ùÑÔ∏è';
      return '‚òÄÔ∏è';
    }

    function updateLiveWeather() {
      fetch(`https://swd.weatherflow.com/swd/rest/observations/station/${stationId}?token=${token}`)
        .then(res => res.json())
        .then(data => {
          let obs = null;
          if (data.stations && data.stations.length > 0 && data.stations[0].last_ob) {
            obs = data.stations[0].last_ob;
          } else if (data.obs && data.obs.length > 0) {
            obs = data.obs[0];
          }

          if (obs) {
            const tempC = obs.air_temperature;
            const tempF = (tempC * 9/5 + 32).toFixed(1);
            const icon = getIconFromConditions(obs);

            document.getElementById('live-icon').textContent = icon;
            document.getElementById('live-weather').innerHTML = `
              <strong>Temperature:</strong> ${tempC.toFixed(1)} ¬∞C / ${tempF} ¬∞F<br>
              <strong>Humidity:</strong> ${obs.relative_humidity} %<br>
              <strong>Pressure:</strong> ${obs.sea_level_pressure} mb<br>
              <strong>Wind:</strong> ${obs.wind_avg} m/s<br>
              <strong>Rain (Last 24h):</strong> ${obs.precip || 0} mm<br>
              <strong>Lightning:</strong> ${obs.lightning_strike_count_last_3hr || 0} strikes (last 3 hrs)
            `;
          } else {
            document.getElementById('live-weather').innerHTML =
              '<div class="error">No station data available.</div>';
          }
        });
    }

    function loadTrends(days = 1) {
      const now = Math.floor(Date.now() / 1000);
      const start = now - days * 24 * 60 * 60;
      fetch(`https://swd.weatherflow.com/swd/rest/observations/station/${stationId}?token=${token}&time_start=${start}&time_end=${now}`)
        .then(res => res.json())
        .then(data => {
          if (data.obs && data.obs.length > 0) {
            const times = [];
            const temps = [], humidities = [], pressures = [], winds = [], rains = [], lightning = [];
            data.obs.forEach(entry => {
              const ts = entry.timestamp || entry.time;
              const date = new Date(ts * 1000);
              const label = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:00`;
              times.push(label);
              temps.push((entry.air_temperature * 9/5 + 32).toFixed(1));
              humidities.push(entry.relative_humidity);
              pressures.push(entry.sea_level_pressure);
              winds.push(entry.wind_avg);
              rains.push(entry.precip || 0);
              lightning.push(entry.lightning_strike_count_last_3hr || 0);
            });
            if (trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(document.getElementById('trendChart'), {
              type: 'line',
              data: { labels: times,
                datasets: [
                  { label: 'Temperature (¬∞F)', data: temps, borderColor: '#e74c3c', fill: false },
                  { label: 'Humidity (%)', data: humidities, borderColor: '#3498db', fill: false },
                  { label: 'Pressure (mb)', data: pressures, borderColor: '#2ecc71', fill: false },
                  { label: 'Wind (m/s)', data: winds, borderColor: '#9b59b6', fill: false },
                  { label: 'Precip (mm)', data: rains, borderColor: '#1abc9c', fill: false },
                  { label: 'Lightning (3hr)', data: lightning, borderColor: '#f39c12', fill: false }
                ]
              },
              options: { plugins: { legend: { display: true } }, interaction: { mode: 'index' } }
            });
          }
        });
    }

    function loadArchive(days = 7) {
      const now = Math.floor(Date.now() / 1000);
      const start = now - days * 24 * 60 * 60;
      fetch(`https://swd.weatherflow.com/swd/rest/observations/station/${stationId}?token=${token}&time_start=${start}&time_end=${now}`)
        .then(res => res.json())
        .then(data => {
          if (!data.obs) return;
          const times = [];
          const temps = [], humidities = [], pressures = [], winds = [], rains = [], lightning = [];
          data.obs.forEach(entry => {
            const ts = entry.timestamp || entry.time;
            const date = new Date(ts * 1000);
            const label = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:00`;
            times.push(label);
            temps.push((entry.air_temperature * 9/5 + 32).toFixed(1));
            humidities.push(entry.relative_humidity);
            pressures.push(entry.sea_level_pressure);
            winds.push(entry.wind_avg);
            rains.push(entry.precip || 0);
            lightning.push(entry.lightning_strike_count_last_3hr || 0);
          });

          const cfg = (label, dataArr, color) => ({
            type: 'line',
            data: { labels: times, datasets: [{ label, data: dataArr, borderColor: color, fill: false }] },
            options: { responsive: true, plugins: { legend: { display: true } } }
          });

          if (archiveCharts.temp) Object.values(archiveCharts).forEach(c => c.destroy());
          archiveCharts.temp = new Chart(document.getElementById('tempChart'), cfg('Temperature (¬∞F)', temps, '#e74c3c'));
          archiveCharts.humidity = new Chart(document.getElementById('humidityChart'), cfg('Humidity (%)', humidities, '#3498db'));
          archiveCharts.pressure = new Chart(document.getElementById('pressureChart'), cfg('Pressure (mb)', pressures, '#2ecc71'));
          archiveCharts.wind = new Chart(document.getElementById('windChart'), cfg('Wind (m/s)', winds, '#9b59b6'));
          archiveCharts.precip = new Chart(document.getElementById('precipChart'), cfg('Precip (mm)', rains, '#1abc9c'));
          archiveCharts.lightning = new Chart(document.getElementById('lightningChart'), cfg('Lightning (3hr)', lightning, '#f39c12'));
        });
    }

    function downloadCSV(days) {
      const now = Math.floor(Date.now() / 1000);
      const start = now - days * 24 * 60 * 60;
      fetch(`https://swd.weatherflow.com/swd/rest/observations/station/${stationId}?token=${token}&time_start=${start}&time_end=${now}`)
        .then(res => res.json())
        .then(data => {
          if (!data.obs) return;
          let csv = "Time,Temperature (¬∞F),Humidity (%),Pressure (mb),Wind (m/s),Precip (mm),Lightning (3hr)\n";
          data.obs.forEach(entry => {
            const ts = entry.timestamp || entry.time;
            const date = new Date(ts * 1000);
            const tempF = (entry.air_temperature * 9/5 + 32).toFixed(1);
            csv += `${date.toISOString()},${tempF},${entry.relative_humidity},${entry.sea_level_pressure},${entry.wind_avg},${entry.precip || 0},${entry.lightning_strike_count_last_3hr || 0}\n`;
          });
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = `weather_${days}d.csv`; a.click();
          URL.revokeObjectURL(url);
        });
    }

    updateLiveWeather();
    loadTrends(1);
    setInterval(updateLiveWeather, 15 * 60 * 1000);
  </script>
</body>
</html>
